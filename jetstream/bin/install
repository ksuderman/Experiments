#!/usr/bin/env bash

if [[ -z $1 ]] ; then
	echo "Please specify one of js1 or js2"
	exit 1
fi

INVENTORY=$HOME/.inventories/$1.ini
HTML=files/welcome-$1.html

if [[ ! -e $INVENTORY ]] ; then
	echo "Inventory file $INVENTORY not found"
	exit 1
fi

cd ansible

if [[ -e $HTML ]] ; then
	echo "Welcome HTML file $HTML not found:"
	exit 1
fi

echo "Performing system update and rebooting (if needed)"
ansible-playbook -i $INVENTORY update.yml

echo "Installing RKE2"
rm rke/outputs/*
ansible-playbook -i $INVENTORY rke/main.yml
config=$(ls rke/outputs)

echo "Copying kubeconfig file"
mv rke/outputs/$config $HOME/.kube/configs/$1
chmod 0600 $HOME/.kube/configs/$1

if [[ -e .ktx ]] ; then
	rm .ktx
fi
#kshim global $1
ln -s ~/.kube/configs/$1 ~/.kube/config
ansible-playbook -i $INVENTORY setup.yml
ansible-playbook -i $INVENTORY cert-manager.yml
cd ../

bin/install-galaxy $HTML
#kshim clear
rm ~/.kube/config
echo "Done"
